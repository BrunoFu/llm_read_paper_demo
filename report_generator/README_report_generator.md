# 模块说明: report_generator

## 1. 模块概述

本模块是整个论文分析流水线的 **第三阶段：异步精读与报告生成**。

它的核心职责是接收由 `section_data_extractor` 模块生成的、高度结构化的章节级 JSON 文件，并通过对每个章节进行并行的、深度的 LLM 分析，最终合成一份完整的、人类易读的 Markdown 格式精读报告。

## 2. 核心功能

- **异步并发处理**: 使用 `asyncio` 和 `Semaphore` 来并发处理论文的各个章节，极大地提升了对长篇论文的分析效率。
- **动态 Prompt 构建**: 为每一个章节动态地、精心地构建一个包含上下文的复杂 Prompt，该 Prompt 会指示 LLM 不仅要总结内容，还要解读其中的图表和数学公式。
- **宏观与微观结合**: 采用两步走的分析策略。首先，对全文内容进行一次宏观概括；然后，对每个章节进行微观的、深入的分析。
- **健壮的 API 调用**: 内置了指数退避的重试机制，能够有效应对临时的网络波动或 API 错误，确保长时间运行任务的稳定性。
- **报告合成**: 将宏观概括和所有章节的微观分析结果，按原始顺序拼接成一份结构清晰、内容丰富的 Markdown 报告。

## 3. 关键文件及其职责

- `LLM_for_paper_reading_updated.py`:
  - **职责**: **本模块的核心调度器**。它包含了异步任务分发、动态 Prompt 构建和最终报告合成的全部核心逻辑。
- `report_processor.py`:
  - **职责**: 提供 `process_report` 等辅助函数，可能用于对最终生成的 Markdown 报告进行一些后处理或格式化操作（例如，提取特定部分或验证格式）。

## 4. 依赖关系

- **内部模块依赖**:
  - `utils.llm_config`: 用于获取 LLM 服务的配置，如 API URL、模型名称等。
  - `utils.llm_client` (推测): 底层的 LLM 通信客户端可能封装在此工具模块中。

- **配置文件依赖**:
  - **环境变量/配置文件**: 需要能够获取到所使用 LLM 服务的 API 密钥和终结点 (Endpoint) 信息。

- **资源文件依赖**:
  - **无**: 与前两个阶段不同，本模块不依赖外部的 `.md` 格式 Prompt 模板，而是**在代码中动态生成所有 Prompt**。

## 5. 工作流程

1.  **输入**: 一个包含论文完整结构和各章节内容的 `.json` 文件路径。
2.  `process_paper_report` 函数被调用。
3.  脚本首先从输入的 JSON 中提取 `level=0` 的内容作为全文文本。
4.  **宏观分析**: 将全文文本提交给 LLM，生成一份“**论文整体概括**”。
5.  **任务准备**:
    - a. 遍历 JSON 中的每一个章节（跳过 `level=0` 和参考文献等特定章节）。
    - b. 为每个章节构建一个包含其**文本内容、图表列表、公式列表**的详细 Prompt。
    - c. 将每个 Prompt 的处理逻辑封装成一个异步任务。
6.  **并发执行**:
    - a. 使用 `asyncio.Semaphore` 限制最大并发数。
    - b. 通过 `asyncio.gather` 并发地执行所有章节的分析任务。
    - c. 使用 `tqdm` 实时显示处理进度。
7.  **结果收集与合成**:
    - a. 等待所有异步任务完成，收集每个章节返回的 Markdown 格式分析结果。
    - b. 将“论文整体概括”和所有章节的分析结果按顺序拼接起来。
8.  **后处理**: (可选) 调用 `report_processor.py` 中的函数对合成的报告进行最终的格式化或处理。
9.  **输出**: 将最终的完整报告保存为一个 `.md` 文件。

## 6. 输入与输出

- **输入**:
  - `json_path`: 字符串，指向由第二阶段生成的、结构化的 `paper_structure.json` 文件。
- **输出**:
  - **主要产物**: 一份 `.md` 格式的论文精读报告。
  - **命名与位置**: 输出的报告文件被存储在由 `output_path` 参数指定的路径。 